<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>å‘˜å·¥å·¥æ—¶ç®¡ç†ç³»ç»Ÿ</title>
    <style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    background: #f5f5f5;
}

.app {
    display: flex;
    min-height: 100vh;
}

/* ä¾§è¾¹å¯¼èˆª */
.sidebar {
    width: 220px;
    background: #304156;
    color: #fff;
    padding: 20px 0;
}

.sidebar h1 {
    font-size: 18px;
    text-align: center;
    padding: 0 20px 20px;
    border-bottom: 1px solid #434a58;
    margin-bottom: 10px;
}

.nav-menu {
    list-style: none;
}

.nav-menu li {
    margin: 5px 0;
}

.nav-link {
    display: block;
    padding: 12px 24px;
    color: #bfcbd9;
    text-decoration: none;
    transition: all 0.3s;
}

.nav-link:hover {
    background: #263445;
    color: #fff;
}

.nav-link.active {
    background: #409eff;
    color: #fff;
}

/* ä¸»å†…å®¹åŒº */
.main-content {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
}

.page {
    display: none;
}

.page.active {
    display: block;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    background: #fff;
    padding: 16px 20px;
    border-radius: 4px;
}

.page-header h2 {
    font-size: 20px;
    color: #303133;
}

.header-actions {
    display: flex;
    align-items: center;
    gap: 16px;
}

/* è¡¨æ ¼ */
.table-container {
    background: #fff;
    border-radius: 4px;
    overflow: hidden;
}

table {
    width: 100%;
    border-collapse: collapse;
}

thead {
    background: #f5f7fa;
}

th {
    padding: 12px 16px;
    text-align: left;
    font-weight: 500;
    color: #606266;
    border-bottom: 1px solid #ebeef5;
}

td {
    padding: 12px 16px;
    border-bottom: 1px solid #ebeef5;
    color: #606266;
}

tbody tr:hover {
    background: #f5f7fa;
}

/* æ—¥å†è¡¨æ ¼ */
.month-selector {
    display: flex;
    align-items: center;
    gap: 8px;
}

.form-select-sm {
    padding: 4px 8px;
    font-size: 14px;
    border: 1px solid #dcdfe6;
    border-radius: 4px;
    cursor: pointer;
}

.calendar-table-container {
    background: #fff;
    border-radius: 4px;
    overflow-x: auto;
}

#worktimes-calendar-table {
    min-width: 100%;
    border-collapse: collapse;
}

#worktimes-calendar-table th,
#worktimes-calendar-table td {
    min-width: 45px;
    text-align: center;
    border: 1px solid #dcdfe6;
    padding: 8px 4px;
    font-size: 13px;
}

#worktimes-calendar-table th {
    background: #e8f4fd;
    font-weight: 700;
    color: #1a5f3e;
    font-size: 14px;
    position: sticky;
    top: 0;
    z-index: 10;
    border-bottom: 2px solid #409eff;
}

#worktimes-calendar-table td {
    background: #fff;
    color: #303133;
    border-color: #ebeef5;
}

#worktimes-calendar-table th:first-child,
#worktimes-calendar-table td:first-child {
    position: sticky;
    left: 0;
    background: #fff;
    z-index: 20;
    min-width: 100px;
    text-align: left;
    padding-left: 12px;
    font-weight: 600;
}

#worktimes-calendar-table th:first-child {
    background: #d9ecff;
    z-index: 30;
    color: #0056b3;
}

/* å‘¨æœ«é«˜äº® */
#worktimes-calendar-table th.weekend,
#worktimes-calendar-table td.weekend {
    background: #fff1f0;
}

#worktimes-calendar-table th.weekend {
    background: #ffccc7;
}

/* å¯ç‚¹å‡»å•å…ƒæ ¼ */
.calendar-cell {
    cursor: pointer;
    transition: background 0.2s;
}

.calendar-cell:hover {
    background: #ecf5ff;
}

.calendar-cell.has-data {
    background: #f0f9ff;
    font-weight: 500;
    color: #409eff;
    position: relative;
}

/* å¤‡æ³¨æ ‡è®° - çº¢ç‚¹ */
.calendar-cell .note-marker {
    position: absolute;
    top: 2px;
    right: 2px;
    width: 6px;
    height: 6px;
    background: #ff4d4f;
    border-radius: 50%;
    box-shadow: 0 0 2px rgba(255, 77, 79, 0.5);
}

/* æœ‰å¤‡æ³¨çš„å•å…ƒæ ¼è¾¹æ¡†é«˜äº® */
.calendar-cell.has-note {
    border: 1px solid #ff7875 !important;
}

/* å‘¨æœ« + å¤‡æ³¨ */
.calendar-cell.has-note.weekend {
    border: 1px solid #ffa39e !important;
}

/* æœ‰å¤‡æ³¨çš„å•å…ƒæ ¼æ‚¬åœæ•ˆæœ */
.calendar-cell.has-note:hover {
    background: #fff1f0 !important;
}

/* æ€»è®¡åˆ— */
.total-cell {
    background: #f5f7fa !important;
    font-weight: 600;
    color: #303133;
    position: sticky;
    right: 0;
    z-index: 5;
    border-left: 2px solid #dcdfe6 !important;
}

#worktimes-calendar-table th.total-header {
    position: sticky;
    right: 0;
    z-index: 35;
    background: #e8f4ff !important;
    border-left: 2px solid #dcdfe6 !important;
}

/* æŒ‰é’® */
.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s;
}

.btn-primary {
    background: #409eff;
    color: #fff;
}

.btn-primary:hover {
    background: #66b1ff;
}

.btn-secondary {
    background: #fff;
    border: 1px solid #dcdfe6;
    color: #606266;
}

.btn-secondary:hover {
    border-color: #c6e2ff;
    background: #ecf5ff;
    color: #409eff;
}

.btn-danger {
    background: #f56c6c;
    color: #fff;
}

.btn-danger:hover {
    background: #f78989;
}

.btn-sm {
    padding: 4px 10px;
    font-size: 12px;
}

.btn-link {
    background: none;
    border: none;
    color: #409eff;
    cursor: pointer;
    padding: 4px 8px;
}

.btn-link:hover {
    color: #66b1ff;
}

/* è¡¨å• */
.form-group {
    margin-bottom: 16px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    color: #606266;
    font-size: 14px;
}

.form-input,
.form-select,
.form-textarea {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #dcdfe6;
    border-radius: 4px;
    font-size: 14px;
    transition: border-color 0.3s;
}

.form-input:focus,
.form-select:focus,
.form-textarea:focus {
    outline: none;
    border-color: #409eff;
}

.form-textarea {
    resize: vertical;
    font-family: inherit;
}

/* å¼¹çª— */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}

.modal.show {
    display: flex;
}

.modal-content {
    background: #fff;
    border-radius: 4px;
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid #ebeef5;
}

.modal-header h3 {
    font-size: 16px;
    color: #303133;
}

.close {
    font-size: 24px;
    color: #909399;
    cursor: pointer;
    line-height: 1;
}

.close:hover {
    color: #303133;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    padding: 16px 20px;
    border-top: 1px solid #ebeef5;
}

.modal-body {
    padding: 20px;
}

.modal-sm {
    max-width: 400px;
}

.cell-info {
    background: #f0f7ff;
    border-left: 3px solid #409eff;
    padding: 10px 12px;
    margin-bottom: 16px;
    font-size: 14px;
    color: #303133;
}

/* æ‰¹é‡å½•å…¥æ ·å¼ */
.section-title {
    font-size: 14px;
    font-weight: 600;
    color: #303133;
    margin-bottom: 8px;
    display: block;
}

.form-section {
    background: #fafafa;
    border: 1px solid #e4e7ed;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
}

.section-label {
    font-size: 15px;
    font-weight: 600;
    color: #303133;
    margin-bottom: 12px;
    display: block;
}

/* æ—¥æœŸåŒºåŸŸ - è“è‰² */
.date-section {
    background: #f0f7ff;
    border-color: #b3d8ff;
}

.date-section .section-label {
    color: #0056b3;
}

/* å·¥æ—¶åŒºåŸŸ - ç»¿è‰² */
.hours-section {
    background: #f0f9f4;
    border-color: #b3e0cc;
}

.hours-section .section-label {
    color: #2e7d32;
}

/* å®šæ—¶åŒºåŸŸ - ç´«è‰² */
.schedule-section {
    background: #f5f0ff;
    border-color: #d4bfff;
}

.schedule-section .section-label {
    color: #722ed1;
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    font-size: 14px;
    color: #303133;
    margin-bottom: 8px;
}

.checkbox-label input[type="checkbox"] {
    cursor: pointer;
    width: 18px;
    height: 18px;
}

.schedule-inputs {
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px dashed #d4bfff;
}

.schedule-inputs label {
    display: block;
    font-size: 13px;
    color: #722ed1;
    margin-bottom: 6px;
}

.schedule-inputs .form-input {
    width: 100%;
}

.schedule-hint {
    margin: 8px 0 0 0;
    font-size: 12px;
    color: #fa8c16;
    background: #fff7e6;
    padding: 8px;
    border-radius: 4px;
}

.active-schedules {
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px dashed #d4bfff;
}

.schedule-item {
    background: #fff;
    border: 1px solid #d4bfff;
    border-radius: 4px;
    padding: 10px;
    margin-bottom: 8px;
    font-size: 13px;
}

.schedule-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 6px;
}

.schedule-item-time {
    font-weight: 600;
    color: #722ed1;
}

.schedule-item-countdown {
    color: #52c41a;
    font-size: 12px;
}

.schedule-cancel {
    background: #ff4d4f;
    color: #fff;
    border: none;
    padding: 2px 8px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 12px;
}

.schedule-item-info {
    color: #606266;
    font-size: 12px;
}

.checkbox-group {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    max-height: 150px;
    overflow-y: auto;
    padding: 8px;
    border: 1px solid #dcdfe6;
    border-radius: 4px;
    background: #fff;
}

.checkbox-item {
    display: flex;
    align-items: center;
    gap: 6px;
}

.checkbox-item input[type="checkbox"] {
    cursor: pointer;
}

.checkbox-item label {
    cursor: pointer;
    margin: 0;
}

/* å…¨é€‰/å…¨ä¸é€‰æŒ‰é’®åŒºåŸŸ */
.checkbox-actions {
    display: flex;
    gap: 8px;
    padding: 8px;
    border-bottom: 1px solid #dcdfe6;
    background: #f5f7fa;
}

.checkbox-actions .btn-sm {
    padding: 4px 12px;
    font-size: 13px;
}

.date-range {
    display: flex;
    align-items: center;
    gap: 10px;
}

.date-range span {
    color: #606266;
    font-weight: 500;
}

.hours-input-group {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
}

.hours-input-group .form-input {
    flex: 1;
}

.hours-unit {
    color: #2e7d32;
    font-weight: 500;
    font-size: 14px;
    white-space: nowrap;
}

.batch-info {
    background: #fff7e6;
    border: 1px solid #ffd591;
    border-radius: 4px;
    padding: 12px;
    margin-top: 16px;
}

.batch-info p {
    margin: 0;
    color: #d46b08;
    font-size: 14px;
}

.batch-info span {
    font-weight: 600;
}

/* ç­›é€‰åŒº */
.filters {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.filters .form-input,
.filters .form-select {
    width: auto;
    min-width: 150px;
}

/* ç©ºçŠ¶æ€ */
.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #909399;
}

/* æ“ä½œæŒ‰é’®ç»„ */
.action-buttons {
    display: flex;
    gap: 8px;
}

/* æ•°æ®ç®¡ç†åŒºåŸŸ */
.data-manager {
    padding: 20px;
    border-top: 1px solid #434a58;
    margin-top: 20px;
}

.data-manager h3 {
    font-size: 14px;
    color: #bfcbd9;
    margin-bottom: 12px;
    padding-left: 4px;
}

.data-manager .btn {
    width: 100%;
    margin-bottom: 8px;
}

.btn-success {
    background: #67c23a;
    color: #fff;
}

.btn-success:hover {
    background: #85ce61;
}

.btn-block {
    width: 100%;
}

/* ==================== ç§»åŠ¨ç«¯å“åº”å¼è®¾è®¡ ==================== */

@media (max-width: 768px) {
    /* æ•´ä½“å¸ƒå±€è°ƒæ•´ */
    .app {
        flex-direction: column;
        height: auto;
        min-height: 100vh;
    }

    /* ä¸»å†…å®¹åŒºåŸŸ */
    .main-content {
        padding: 10px;
        overflow: visible;
        flex: 1;
    }

    /* é¡µé¢æ˜¾ç¤º */
    .page {
        display: none;
    }

    .page.active {
        display: block;
    }

    /* ä¾§è¾¹æ æ”¹ä¸ºé¡¶éƒ¨å¯¼èˆª */
    .sidebar {
        width: 100%;
        padding: 10px 0;
    }

    .sidebar h1 {
        font-size: 16px;
        padding: 0 15px 10px;
    }

    .nav-menu {
        display: flex;
        overflow-x: auto;
        padding: 0 10px;
        gap: 0;
    }

    .nav-menu li {
        margin: 0;
        flex-shrink: 0;
    }

    .nav-link {
        padding: 10px 15px;
        white-space: nowrap;
    }

    /* é¡µé¢å¤´éƒ¨ */
    .page-header {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
        padding: 12px 15px;
    }

    .page-header h2 {
        font-size: 18px;
        text-align: center;
    }

    /* æœˆä»½é€‰æ‹©å™¨ */
    .header-actions {
        flex-direction: column;
        width: 100%;
    }

    .month-selector {
        justify-content: center;
        flex-wrap: wrap;
        width: 100%;
    }

    .form-select-sm {
        flex: 1;
        min-width: 80px;
    }

    /* æ—¥å†è¡¨æ ¼å®¹å™¨ */
    .calendar-table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        max-height: calc(100vh - 200px);
        overflow-y: auto;
    }

    #worktimes-calendar-table {
        min-width: max-content;
    }

    /* ç§»åŠ¨ç«¯ç¦ç”¨stickyå®šä½ */
    #worktimes-calendar-table th,
    #worktimes-calendar-table td {
        position: static !important;
    }

    #worktimes-calendar-table th,
    #worktimes-calendar-table td {
        min-width: 38px;
        padding: 6px 2px;
        font-size: 12px;
    }

    #worktimes-calendar-table th:first-child,
    #worktimes-calendar-table td:first-child {
        min-width: 70px;
        padding-left: 8px;
        font-size: 13px;
    }

    /* å¤‡æ³¨çº¢ç‚¹é€‚é… */
    .calendar-cell .note-marker {
        width: 5px;
        height: 5px;
        top: 1px;
        right: 1px;
    }

    /* å¼¹çª—é€‚é… */
    .modal-content {
        width: 95%;
        max-height: 85vh;
    }

    .modal-body {
        padding: 15px;
    }

    .modal-footer {
        padding: 12px 15px;
        flex-wrap: wrap;
        gap: 8px;
    }

    .modal-footer .btn {
        flex: 1;
        min-width: 60px;
        font-size: 13px;
    }

    /* æ‰¹é‡å½•å…¥è¡¨å• */
    .checkbox-group {
        grid-template-columns: 1fr;
        max-height: 120px;
    }

    .form-section {
        padding: 12px;
    }

    .date-range {
        flex-direction: column;
        gap: 8px;
    }

    .date-range span {
        display: none;
    }

    .hours-input-group {
        flex-direction: column;
        align-items: stretch;
    }

    /* æŒ‰é’®é€‚é… */
    .btn {
        padding: 10px 14px;
        font-size: 14px;
        touch-action: manipulation;
    }

    /* è¡¨æ ¼å®¹å™¨ */
    .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    table {
        font-size: 12px;
    }

    th, td {
        padding: 8px 6px;
    }

    /* ç­›é€‰åŒº */
    .filters {
        flex-direction: column;
        align-items: stretch;
    }

    .filters .form-input,
    .filters .form-select {
        width: 100%;
        min-width: auto;
    }

    /* æ•°æ®ç®¡ç†åŒºåŸŸ */
    .data-manager {
        padding: 15px;
    }

    /* å‘˜å·¥è¡¨æ ¼ */
    #employees-table th:nth-child(4),
    #employees-table td:nth-child(4) {
        display: none;
    }

    #employees-table::after {
        content: 'â†’ ç‚¹å‡»å•å…ƒæ ¼ç¼–è¾‘';
        display: table-row;
        text-align: center;
        padding: 10px;
        color: #909399;
        font-size: 12px;
    }
}

/* è¶…å°å±å¹•é€‚é… */
@media (max-width: 480px) {
    .sidebar h1 {
        font-size: 14px;
    }

    .page-header h2 {
        font-size: 16px;
    }

    /* ç¡®ä¿è¡¨æ ¼å®¹å™¨æœ‰é«˜åº¦ */
    .calendar-table-container {
        max-height: calc(100vh - 240px);
    }

    #worktimes-calendar-table th,
    #worktimes-calendar-table td {
        min-width: 32px;
        font-size: 11px;
        padding: 4px 1px;
    }

    #worktimes-calendar-table th:first-child,
    #worktimes-calendar-table td:first-child {
        min-width: 60px;
        font-size: 12px;
    }

    .calendar-cell .note-marker {
        width: 4px;
        height: 4px;
    }

    /* å¼¹çª—æ›´å° */
    .modal-content {
        width: 98%;
    }

    .form-group label {
        font-size: 13px;
    }

    .form-input,
    .form-select,
    .form-textarea {
        font-size: 14px;
    }
}
    </style>
</head>
<body>
    <div class="app">
        <!-- ä¾§è¾¹å¯¼èˆª -->
        <nav class="sidebar">
            <h1>å·¥æ—¶ç®¡ç†ç³»ç»Ÿ</h1>
            <ul class="nav-menu">
                <li>
                    <a href="#employees" class="nav-link active" data-page="employees">
                        å‘˜å·¥ç®¡ç†
                    </a>
                </li>
                <li>
                    <a href="#worktimes" class="nav-link" data-page="worktimes">
                        å·¥æ—¶è®°å½•
                    </a>
                </li>
                <li>
                    <a href="#statistics" class="nav-link" data-page="statistics">
                        ç»Ÿè®¡æŠ¥è¡¨
                    </a>
                </li>
            </ul>

            <!-- æ•°æ®ç®¡ç† -->
            <div class="data-manager">
                <h3>æ•°æ®ç®¡ç†</h3>
                <button class="btn btn-success btn-block" onclick="exportData()">å¯¼å‡ºæ•°æ®</button>
                <button class="btn btn-secondary btn-block" onclick="document.getElementById('import-file').click()">å¯¼å…¥æ•°æ®</button>
                <button class="btn btn-danger btn-block" onclick="clearData()">æ¸…é™¤æ•°æ®</button>
                <input type="file" id="import-file" accept=".json" style="display: none" onchange="importData(event)">
            </div>
        </nav>

        <!-- ä¸»å†…å®¹åŒº -->
        <main class="main-content">
            <!-- å‘˜å·¥ç®¡ç†é¡µé¢ -->
            <div id="page-employees" class="page active">
                <div class="page-header">
                    <h2>å‘˜å·¥ç®¡ç†</h2>
                    <button class="btn btn-primary" onclick="showEmployeeModal()">æ·»åŠ å‘˜å·¥</button>
                </div>

                <div class="table-container">
                    <table id="employees-table">
                        <thead>
                            <tr>
                                <th>å·¥å·</th>
                                <th>å§“å</th>
                                <th>éƒ¨é—¨</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- å·¥æ—¶è®°å½•é¡µé¢ -->
            <div id="page-worktimes" class="page">
                <div class="page-header">
                    <h2>å·¥æ—¶è®°å½•</h2>
                    <div class="header-actions">
                        <div class="month-selector">
                            <button class="btn btn-sm" onclick="changeMonth(-1)">&lt;</button>
                            <select id="year-select" class="form-select-sm" onchange="changeYear()"></select>
                            <select id="month-select" class="form-select-sm" onchange="changeMonthSelect()"></select>
                            <button class="btn btn-sm" onclick="changeMonth(1)">&gt;</button>
                        </div>
                        <button class="btn btn-success" onclick="showBatchModal()">æ‰¹é‡å½•å…¥</button>
                    </div>
                </div>

                <div class="calendar-table-container">
                    <table id="worktimes-calendar-table">
                        <thead>
                            <tr id="calendar-header"></tr>
                        </thead>
                        <tbody id="calendar-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- ç»Ÿè®¡æŠ¥è¡¨é¡µé¢ -->
            <div id="page-statistics" class="page">
                <div class="page-header">
                    <h2>ç»Ÿè®¡æŠ¥è¡¨</h2>
                </div>

                <div class="filters">
                    <select id="stats-employee" class="form-select">
                        <option value="">å…¨éƒ¨å‘˜å·¥</option>
                    </select>
                    <input type="date" id="stats-start" class="form-input">
                    <input type="date" id="stats-end" class="form-input">
                    <select id="stats-sort" class="form-select">
                        <option value="name_asc">å‘˜å·¥å§“å â†‘</option>
                        <option value="name_desc">å‘˜å·¥å§“å â†“</option>
                        <option value="hours_asc">æ€»å·¥æ—¶ â†‘</option>
                        <option value="hours_desc">æ€»å·¥æ—¶ â†“</option>
                        <option value="count_asc">è®°å½•æ•° â†‘</option>
                        <option value="count_desc">è®°å½•æ•° â†“</option>
                    </select>
                </div>

                <div class="table-container">
                    <table id="statistics-table">
                        <thead>
                            <tr>
                                <th>å‘˜å·¥</th>
                                <th>æ€»å·¥æ—¶</th>
                                <th>è®°å½•æ•°</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- å‘˜å·¥å¼¹çª— -->
    <div id="employee-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="employee-modal-title">æ·»åŠ å‘˜å·¥</h3>
                <span class="close" onclick="closeEmployeeModal()">&times;</span>
            </div>
            <form id="employee-form" onsubmit="saveEmployee(event)">
                <input type="hidden" id="employee-id">
                <div class="modal-body">
                    <div class="form-group">
                        <label>å·¥å·</label>
                        <input type="text" id="employee-code" class="form-input" placeholder="è¯·è¾“å…¥å·¥å·" required>
                    </div>
                    <div class="form-group">
                        <label>å§“å</label>
                        <input type="text" id="employee-name" class="form-input" placeholder="è¯·è¾“å…¥å§“å" required>
                    </div>
                    <div class="form-group">
                        <label>éƒ¨é—¨</label>
                        <select id="employee-dept" class="form-select" required>
                            <option value="">è¯·é€‰æ‹©éƒ¨é—¨</option>
                            <option value="æŠ€æœ¯éƒ¨">æŠ€æœ¯éƒ¨</option>
                            <option value="äº§å“éƒ¨">äº§å“éƒ¨</option>
                            <option value="è®¾è®¡éƒ¨">è®¾è®¡éƒ¨</option>
                            <option value="è¿è¥éƒ¨">è¿è¥éƒ¨</option>
                            <option value="å¸‚åœºéƒ¨">å¸‚åœºéƒ¨</option>
                            <option value="é”€å”®éƒ¨">é”€å”®éƒ¨</option>
                            <option value="äººäº‹éƒ¨">äººäº‹éƒ¨</option>
                            <option value="è´¢åŠ¡éƒ¨">è´¢åŠ¡éƒ¨</option>
                            <option value="è¡Œæ”¿éƒ¨">è¡Œæ”¿éƒ¨</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeEmployeeModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- å·¥æ—¶å¼¹çª— -->
    <div id="worktime-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="worktime-modal-title">æ·»åŠ å·¥æ—¶è®°å½•</h3>
                <span class="close" onclick="closeWorktimeModal()">&times;</span>
            </div>
            <form id="worktime-form" onsubmit="saveWorktime(event)">
                <input type="hidden" id="worktime-id">
                <div class="modal-body">
                    <div class="form-group">
                        <label>å‘˜å·¥</label>
                        <select id="worktime-employee" class="form-select" required>
                            <option value="">è¯·é€‰æ‹©å‘˜å·¥</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æ—¥æœŸ</label>
                        <input type="date" id="worktime-date" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label>å·¥æ—¶</label>
                        <input type="number" id="worktime-hours" class="form-input" step="0.5" min="0" max="24" placeholder="è¯·è¾“å…¥å·¥æ—¶ï¼ˆ0-24ï¼‰" required>
                    </div>
                    <div class="form-group">
                        <label>å¤‡æ³¨</label>
                        <textarea id="worktime-note" class="form-textarea" rows="3" placeholder="è¯·è¾“å…¥å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeWorktimeModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- æ‰¹é‡å½•å…¥å¼¹çª— -->
    <div id="batch-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ‰¹é‡å½•å…¥å·¥æ—¶</h3>
                <span class="close" onclick="closeBatchModal()">&times;</span>
            </div>
            <form id="batch-form" onsubmit="submitBatch(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="section-title">é€‰æ‹©å‘˜å·¥</label>
                        <div id="batch-employees" class="checkbox-group"></div>
                    </div>

                    <div class="form-section date-section">
                        <label class="section-label">ğŸ“… æ—¥æœŸèŒƒå›´</label>
                        <div class="date-range">
                            <input type="date" id="batch-start-date" class="form-input" required>
                            <span>è‡³</span>
                            <input type="date" id="batch-end-date" class="form-input" required>
                        </div>
                    </div>

                    <div class="form-section hours-section">
                        <label class="section-label">â° å·¥æ—¶è®¾ç½®</label>
                        <div class="hours-input-group">
                            <input type="number" id="batch-hours" class="form-input" step="0.5" min="0" max="24" placeholder="è¯·è¾“å…¥å·¥æ—¶ï¼ˆ0-24ï¼‰" required>
                            <span class="hours-unit">å°æ—¶/å¤©</span>
                        </div>
                        <textarea id="batch-note" class="form-textarea" rows="2" placeholder="è¯·è¾“å…¥å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰"></textarea>
                    </div>

                    <div class="form-section schedule-section">
                        <label class="section-label">â±ï¸ å®šæ—¶å½•å…¥ï¼ˆå¯é€‰ï¼‰</label>
                        <div class="schedule-options">
                            <label class="checkbox-label">
                                <input type="checkbox" id="enable-schedule" onchange="toggleSchedule()">
                                å¯ç”¨å®šæ—¶å½•å…¥
                            </label>
                            <div id="schedule-inputs" class="schedule-inputs" style="display: none;">
                                <label>æ‰§è¡Œæ—¶é—´ï¼š</label>
                                <input type="datetime-local" id="schedule-time" class="form-input">
                                <p class="schedule-hint">âš ï¸ é¡µé¢å¿…é¡»ä¿æŒæ‰“å¼€ï¼Œåˆ°æ—¶é—´åä¼šè‡ªåŠ¨æ‰§è¡Œ</p>
                            </div>
                        </div>
                        <div id="active-schedules" class="active-schedules"></div>
                    </div>

                    <div class="batch-info">
                        <p>å°†ä¸ºé€‰ä¸­å‘˜å·¥åœ¨ <span id="batch-preview-dates"></span> æœŸé—´æ¯å¤©å½•å…¥ <span id="batch-preview-hours"></span> å°æ—¶</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeBatchModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary" id="batch-submit-btn">ç«‹å³å½•å…¥</button>
                </div>
            </form>
        </div>
    </div>

    <!-- å•å…ƒæ ¼ç¼–è¾‘å¼¹çª— -->
    <div id="cell-modal" class="modal">
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h3 id="cell-modal-title">ç¼–è¾‘å·¥æ—¶</h3>
                <span class="close" onclick="closeCellModal()">&times;</span>
            </div>
            <form id="cell-form" onsubmit="saveCellData(event)">
                <input type="hidden" id="cell-employee-id">
                <input type="hidden" id="cell-date">
                <input type="hidden" id="cell-worktime-id">
                <div class="modal-body">
                    <p id="cell-info" class="cell-info"></p>
                    <div class="form-group">
                        <label>å·¥æ—¶</label>
                        <input type="number" id="cell-hours" class="form-input" step="0.5" min="0" max="24" placeholder="è¯·è¾“å…¥å·¥æ—¶ï¼ˆ0-24ï¼‰">
                    </div>
                    <div class="form-group">
                        <label>å¤‡æ³¨</label>
                        <textarea id="cell-note" class="form-textarea" rows="3" placeholder="è¯·è¾“å…¥å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" onclick="deleteCellData()">åˆ é™¤</button>
                    <button type="button" class="btn btn-secondary" onclick="closeCellModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script>
// ==================== localStorage æ•°æ®æ“ä½œ ====================

const DB_KEYS = {
    EMPLOYEES: 'worktime_employees',
    WORKTIMES: 'worktime_worktimes'
};

// ç”Ÿæˆå”¯ä¸€ID
function generateId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
}

// è·å–æ•°æ®
function getData(key) {
    const data = localStorage.getItem(key);
    return data ? JSON.parse(data) : [];
}

// ä¿å­˜æ•°æ®
function saveData(key, data) {
    localStorage.setItem(key, JSON.stringify(data));
}

// ==================== å·¥å…·å‡½æ•° ====================

function formatDate(date) {
    const d = new Date(date);
    return d.toISOString().split('T')[0];
}

// ==================== è·¯ç”±å¯¼èˆª ====================

const navLinks = document.querySelectorAll('.nav-link');
const pages = document.querySelectorAll('.page');

navLinks.forEach(link => {
    link.addEventListener('click', (e) => {
        e.preventDefault();
        const pageName = link.dataset.page;

        // æ›´æ–°å¯¼èˆªçŠ¶æ€
        navLinks.forEach(l => l.classList.remove('active'));
        link.classList.add('active');

        // åˆ‡æ¢é¡µé¢
        pages.forEach(p => p.classList.remove('active'));
        document.getElementById('page-' + pageName).classList.add('active');

        // åŠ è½½é¡µé¢æ•°æ®
        if (pageName === 'employees') loadEmployees();
        if (pageName === 'worktimes') loadWorktimes();
        if (pageName === 'statistics') {
            loadEmployeeOptions();
            loadStatistics();
        }
    });
});

// ==================== å‘˜å·¥ç®¡ç† ====================

let employees = [];

function loadEmployees() {
    employees = getData(DB_KEYS.EMPLOYEES);
    renderEmployees();
}

function renderEmployees() {
    const tbody = document.querySelector('#employees-table tbody');
    if (employees.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="empty-state">æš‚æ— æ•°æ®</td></tr>';
        return;
    }
    tbody.innerHTML = employees.map(emp => `
        <tr>
            <td>${emp.employee_id}</td>
            <td>${emp.name}</td>
            <td>${emp.department}</td>
            <td>
                <div class="action-buttons">
                    <button class="btn-link" onclick="editEmployee('${emp.id}')">ç¼–è¾‘</button>
                    <button class="btn-link" onclick="deleteEmployee('${emp.id}')">åˆ é™¤</button>
                </div>
            </td>
        </tr>
    `).join('');
}

function showEmployeeModal(employee = null) {
    const modal = document.getElementById('employee-modal');
    const title = document.getElementById('employee-modal-title');
    const form = document.getElementById('employee-form');

    form.reset();
    document.getElementById('employee-id').value = '';

    if (employee) {
        title.textContent = 'ç¼–è¾‘å‘˜å·¥';
        document.getElementById('employee-id').value = employee.id;
        document.getElementById('employee-code').value = employee.employee_id;
        document.getElementById('employee-name').value = employee.name;
        document.getElementById('employee-dept').value = employee.department;
    } else {
        title.textContent = 'æ·»åŠ å‘˜å·¥';
    }

    modal.classList.add('show');
}

function closeEmployeeModal() {
    document.getElementById('employee-modal').classList.remove('show');
}

function saveEmployee(e) {
    e.preventDefault();

    const id = document.getElementById('employee-id').value;
    const employeeData = {
        employee_id: document.getElementById('employee-code').value,
        name: document.getElementById('employee-name').value,
        department: document.getElementById('employee-dept').value
    };

    // æ£€æŸ¥å·¥å·æ˜¯å¦é‡å¤
    const exists = employees.some(emp =>
        emp.employee_id === employeeData.employee_id && emp.id !== id
    );
    if (exists) {
        alert('å·¥å·å·²å­˜åœ¨');
        return;
    }

    if (id) {
        // ç¼–è¾‘
        const index = employees.findIndex(e => e.id === id);
        if (index !== -1) {
            employees[index] = { ...employees[index], ...employeeData };
        }
    } else {
        // æ–°å¢
        employees.push({
            id: generateId(),
            ...employeeData
        });
    }

    saveData(DB_KEYS.EMPLOYEES, employees);
    closeEmployeeModal();
    loadEmployees();
}

function editEmployee(id) {
    const employee = employees.find(e => e.id === id);
    if (employee) showEmployeeModal(employee);
}

function deleteEmployee(id) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥å‘˜å·¥å—ï¼Ÿ\n\næ³¨æ„ï¼šè¯¥å‘˜å·¥çš„å·¥æ—¶è®°å½•å°†ä¿ç•™ï¼Œä½†ä¼šæ˜¾ç¤ºä¸ºå·¥å·ã€‚')) return;

    employees = employees.filter(e => e.id !== id);
    saveData(DB_KEYS.EMPLOYEES, employees);
    loadEmployees();
}

// ==================== å·¥æ—¶è®°å½• ====================

let worktimes = [];
let currentYear = new Date().getFullYear();
let currentMonth = new Date().getMonth() + 1; // 1-12

function loadWorktimes() {
    worktimes = getData(DB_KEYS.WORKTIMES);
    initMonthSelectors();
    renderCalendar();
}

// åˆå§‹åŒ–æœˆä»½é€‰æ‹©å™¨
function initMonthSelectors() {
    const yearSelect = document.getElementById('year-select');
    const monthSelect = document.getElementById('month-select');

    // ç”Ÿæˆå¹´ä»½é€‰é¡¹ï¼ˆå‰å5å¹´ï¼‰
    const currentYearNow = new Date().getFullYear();
    let yearOptions = '';
    for (let y = currentYearNow - 5; y <= currentYearNow + 5; y++) {
        yearOptions += `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}å¹´</option>`;
    }
    yearSelect.innerHTML = yearOptions;

    // ç”Ÿæˆæœˆä»½é€‰é¡¹
    let monthOptions = '';
    for (let m = 1; m <= 12; m++) {
        monthOptions += `<option value="${m}" ${m === currentMonth ? 'selected' : ''}>${m}æœˆ</option>`;
    }
    monthSelect.innerHTML = monthOptions;
}

// æ¸²æŸ“æ—¥å†è¡¨æ ¼
function renderCalendar() {
    const headerRow = document.getElementById('calendar-header');
    const tbody = document.getElementById('calendar-body');
    const yearSelect = document.getElementById('year-select');
    const monthSelect = document.getElementById('month-select');

    // åŒæ­¥é€‰æ‹©å™¨å€¼
    yearSelect.value = currentYear;
    monthSelect.value = currentMonth;

    // è·å–å½“æœˆå¤©æ•°
    const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();

    // æ¸²æŸ“è¡¨å¤´ï¼ˆå§“å + 1-31å· + åˆè®¡ï¼‰
    let headerHTML = '<th>å§“å</th>';
    for (let i = 1; i <= daysInMonth; i++) {
        const date = new Date(currentYear, currentMonth - 1, i);
        const dayOfWeek = date.getDay();
        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
        headerHTML += `<th class="${isWeekend ? 'weekend' : ''}">${i}</th>`;
    }
    headerHTML += '<th class="total-header">åˆè®¡</th>';
    headerRow.innerHTML = headerHTML;

    // è·å–å‘˜å·¥åˆ—è¡¨
    const employees = getData(DB_KEYS.EMPLOYEES);
    if (employees.length === 0) {
        tbody.innerHTML = '<tr><td colspan="32" class="empty-state">è¯·å…ˆæ·»åŠ å‘˜å·¥</td></tr>';
        return;
    }

    // æ„å»ºå·¥æ—¶æ•°æ®æ˜ å°„
    const worktimeMap = {};
    worktimes.forEach(wt => {
        const key = `${wt.employee_id}_${wt.date}`;
        worktimeMap[key] = wt;
    });

    // æ¸²æŸ“å‘˜å·¥è¡Œ
    const bodyHTML = employees.map(emp => {
        let rowHTML = `<td>${emp.name}</td>`;
        let monthlyTotal = 0;

        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const key = `${emp.employee_id}_${dateStr}`;
            const wt = worktimeMap[key];
            const date = new Date(currentYear, currentMonth - 1, day);
            const isWeekend = date.getDay() === 0 || date.getDay() === 6;

            const hasData = !!wt;
            const hasNote = wt && wt.note && wt.note.trim() !== '';
            const cellClass = hasData ? 'calendar-cell has-data' : 'calendar-cell';
            const cellValue = hasData ? wt.work_hours : '';

            // ç´¯åŠ å½“æœˆå·¥æ—¶
            if (wt) {
                monthlyTotal += wt.work_hours;
            }

            // æ„å»º tooltip å†…å®¹
            let tooltipText = `${emp.name} - ${dateStr}`;
            if (hasData) {
                tooltipText += `\nå·¥æ—¶ï¼š${wt.work_hours} å°æ—¶`;
            }
            if (hasNote) {
                tooltipText += `\nå¤‡æ³¨ï¼š${wt.note}`;
            }
            tooltipText += '\nç‚¹å‡»ç¼–è¾‘';

            // å¤‡æ³¨æ ‡è®°
            const noteMarker = hasNote ? '<span class="note-marker"></span>' : '';

            rowHTML += `<td class="${cellClass} ${isWeekend ? 'weekend' : ''} ${hasNote ? 'has-note' : ''}"
                           onclick="editCalendarCell('${emp.employee_id}', '${emp.name}', '${dateStr}', ${wt ? `'${wt.id}'` : 'null'})"
                           title="${tooltipText}">
                           ${cellValue}${noteMarker}
                       </td>`;
        }

        // æ·»åŠ åˆè®¡åˆ—
        rowHTML += `<td class="total-cell">${monthlyTotal}</td>`;

        return `<tr>${rowHTML}</tr>`;
    }).join('');

    tbody.innerHTML = bodyHTML;
}

// åˆ‡æ¢æœˆä»½ï¼ˆå‰åæŒ‰é’®ï¼‰
function changeMonth(delta) {
    currentMonth += delta;
    if (currentMonth > 12) {
        currentMonth = 1;
        currentYear++;
    } else if (currentMonth < 1) {
        currentMonth = 12;
        currentYear--;
    }
    renderCalendar();
}

// é€‰æ‹©å¹´ä»½
function changeYear() {
    currentYear = parseInt(document.getElementById('year-select').value);
    renderCalendar();
}

// é€‰æ‹©æœˆä»½
function changeMonthSelect() {
    currentMonth = parseInt(document.getElementById('month-select').value);
    renderCalendar();
}

// ç‚¹å‡»å•å…ƒæ ¼ç¼–è¾‘
function editCalendarCell(employeeId, employeeName, date, worktimeId) {
    const modal = document.getElementById('cell-modal');
    const form = document.getElementById('cell-form');
    const info = document.getElementById('cell-info');

    form.reset();

    // è®¾ç½®éšè—å­—æ®µ
    document.getElementById('cell-employee-id').value = employeeId;
    document.getElementById('cell-date').value = date;
    document.getElementById('cell-worktime-id').value = worktimeId || '';

    // æ˜¾ç¤ºä¿¡æ¯
    info.textContent = `${employeeName} - ${date}`;

    // å¦‚æœæœ‰ç°æœ‰æ•°æ®ï¼Œå¡«å……è¡¨å•
    if (worktimeId) {
        const worktime = worktimes.find(w => w.id === worktimeId);
        if (worktime) {
            document.getElementById('cell-hours').value = worktime.work_hours;
            document.getElementById('cell-note').value = worktime.note || '';
        }
        document.getElementById('cell-modal-title').textContent = 'ç¼–è¾‘å·¥æ—¶';
    } else {
        document.getElementById('cell-modal-title').textContent = 'æ·»åŠ å·¥æ—¶';
    }

    modal.classList.add('show');
}

// å…³é—­å•å…ƒæ ¼å¼¹çª—
function closeCellModal() {
    document.getElementById('cell-modal').classList.remove('show');
}

// ä¿å­˜å•å…ƒæ ¼æ•°æ®
function saveCellData(e) {
    e.preventDefault();

    const employeeId = document.getElementById('cell-employee-id').value;
    const date = document.getElementById('cell-date').value;
    const worktimeId = document.getElementById('cell-worktime-id').value;
    const hours = parseFloat(document.getElementById('cell-hours').value);
    const note = document.getElementById('cell-note').value;

    // éªŒè¯å·¥æ—¶
    if (isNaN(hours) || hours < 0 || hours > 24) {
        alert('è¯·è¾“å…¥0-24ä¹‹é—´çš„å·¥æ—¶æ•°');
        return;
    }

    if (worktimeId) {
        // æ›´æ–°è®°å½•
        const index = worktimes.findIndex(w => w.id === worktimeId);
        if (index !== -1) {
            worktimes[index].work_hours = hours;
            worktimes[index].note = note;
            saveData(DB_KEYS.WORKTIMES, worktimes);
        }
    } else {
        // æ–°å¢è®°å½•
        worktimes.push({
            id: generateId(),
            employee_id: employeeId,
            date: date,
            work_hours: hours,
            note: note
        });
        saveData(DB_KEYS.WORKTIMES, worktimes);
    }

    closeCellModal();
    renderCalendar();
}

// åˆ é™¤å•å…ƒæ ¼æ•°æ®
function deleteCellData() {
    const worktimeId = document.getElementById('cell-worktime-id').value;

    if (!worktimeId) {
        closeCellModal();
        return;
    }

    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
        return;
    }

    worktimes = worktimes.filter(w => w.id !== worktimeId);
    saveData(DB_KEYS.WORKTIMES, worktimes);

    closeCellModal();
    renderCalendar();
}

function showWorktimeModal(worktime = null) {
    const modal = document.getElementById('worktime-modal');
    const title = document.getElementById('worktime-modal-title');
    const form = document.getElementById('worktime-form');

    form.reset();
    document.getElementById('worktime-id').value = '';

    // åŠ è½½å‘˜å·¥é€‰é¡¹
    loadEmployeeOptions('worktime-employee');

    if (worktime) {
        title.textContent = 'ç¼–è¾‘å·¥æ—¶è®°å½•';
        document.getElementById('worktime-id').value = worktime.id;
        document.getElementById('worktime-employee').value = worktime.employee_id;
        document.getElementById('worktime-date').value = worktime.date;
        document.getElementById('worktime-hours').value = worktime.work_hours;
        document.getElementById('worktime-note').value = worktime.note || '';
    } else {
        title.textContent = 'æ·»åŠ å·¥æ—¶è®°å½•';
        document.getElementById('worktime-date').value = formatDate(new Date());
    }

    modal.classList.add('show');
}

function closeWorktimeModal() {
    document.getElementById('worktime-modal').classList.remove('show');
}

function saveWorktime(e) {
    e.preventDefault();

    const id = document.getElementById('worktime-id').value;
    const worktimeData = {
        employee_id: document.getElementById('worktime-employee').value,
        date: document.getElementById('worktime-date').value,
        work_hours: parseFloat(document.getElementById('worktime-hours').value),
        note: document.getElementById('worktime-note').value
    };

    if (id) {
        // ç¼–è¾‘
        const index = worktimes.findIndex(w => w.id === id);
        if (index !== -1) {
            worktimes[index] = { ...worktimes[index], ...worktimeData };
        }
    } else {
        // æ–°å¢
        worktimes.push({
            id: generateId(),
            ...worktimeData
        });
    }

    saveData(DB_KEYS.WORKTIMES, worktimes);
    closeWorktimeModal();
    loadWorktimes();
}

function editWorktime(id) {
    const worktime = worktimes.find(w => w.id === id);
    if (worktime) showWorktimeModal(worktime);
}

function deleteWorktime(id) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥è®°å½•å—ï¼Ÿ')) return;

    worktimes = worktimes.filter(w => w.id !== id);
    saveData(DB_KEYS.WORKTIMES, worktimes);
    loadWorktimes();
}

// ==================== æ‰¹é‡å½•å…¥ ====================

function showBatchModal() {
    const modal = document.getElementById('batch-modal');
    const form = document.getElementById('batch-form');

    form.reset();

    // åŠ è½½å‘˜å·¥åˆ—è¡¨ï¼ˆå¤é€‰æ¡†ï¼‰
    const employees = getData(DB_KEYS.EMPLOYEES);
    const checkboxContainer = document.getElementById('batch-employees');

    if (employees.length === 0) {
        checkboxContainer.innerHTML = '<p style="color: #909399; padding: 8px;">æš‚æ— å‘˜å·¥</p>';
    } else {
        checkboxContainer.innerHTML = `
            <div class="checkbox-actions">
                <button type="button" class="btn btn-sm btn-primary" onclick="toggleAllEmployees(true)">å…¨é€‰</button>
                <button type="button" class="btn btn-sm btn-secondary" onclick="toggleAllEmployees(false)">å…¨ä¸é€‰</button>
            </div>
            ${employees.map(emp => `
                <div class="checkbox-item">
                    <input type="checkbox" id="batch-emp-${emp.id}" value="${emp.employee_id}" checked>
                    <label for="batch-emp-${emp.id}">${emp.name} (${emp.employee_id})</label>
                </div>
            `).join('')}
        `;
    }

    // è®¾ç½®é»˜è®¤æ—¥æœŸèŒƒå›´ï¼ˆä»Šå¤©åˆ°å½“å¤©ï¼‰
    const today = new Date();
    document.getElementById('batch-start-date').value = formatDate(today);
    document.getElementById('batch-end-date').value = formatDate(today);

    // æ›´æ–°é¢„è§ˆ
    updateBatchPreview();

    modal.classList.add('show');
}

function closeBatchModal() {
    document.getElementById('batch-modal').classList.remove('show');
}

// å…¨é€‰/å…¨ä¸é€‰å‘˜å·¥
function toggleAllEmployees(checked) {
    const checkboxes = document.querySelectorAll('#batch-employees input[type="checkbox"]');
    checkboxes.forEach(cb => {
        cb.checked = checked;
    });
}

function updateBatchPreview() {
    const startDate = document.getElementById('batch-start-date').value;
    const endDate = document.getElementById('batch-end-date').value;
    const hours = document.getElementById('batch-hours').value;

    const previewDates = document.getElementById('batch-preview-dates');
    const previewHours = document.getElementById('batch-preview-hours');

    if (startDate && endDate) {
        previewDates.textContent = `${startDate} è‡³ ${endDate}`;
    } else {
        previewDates.textContent = '---';
    }

    previewHours.textContent = hours || '---';
}

// ç›‘å¬è¾“å…¥å˜åŒ–æ›´æ–°é¢„è§ˆ
document.addEventListener('DOMContentLoaded', function() {
    const batchInputs = ['batch-start-date', 'batch-end-date', 'batch-hours'];
    batchInputs.forEach(id => {
        document.getElementById(id)?.addEventListener('input', updateBatchPreview);
    });
});

function submitBatch(e) {
    e.preventDefault();

    // æ£€æŸ¥æ˜¯å¦å¯ç”¨å®šæ—¶å½•å…¥
    const enableSchedule = document.getElementById('enable-schedule').checked;

    if (enableSchedule) {
        // å®šæ—¶å½•å…¥
        const scheduleTime = document.getElementById('schedule-time').value;
        if (!scheduleTime) {
            alert('è¯·é€‰æ‹©æ‰§è¡Œæ—¶é—´');
            return;
        }

        const executeTime = new Date(scheduleTime);
        const now = new Date();

        if (executeTime <= now) {
            alert('æ‰§è¡Œæ—¶é—´å¿…é¡»æ™šäºå½“å‰æ—¶é—´');
            return;
        }

        // åˆ›å»ºå®šæ—¶ä»»åŠ¡
        createSchedule(executeTime);
        return;
    }

    // ç«‹å³æ‰§è¡Œæ‰¹é‡å½•å…¥
    executeBatchEntry();
}

// æ‰§è¡Œæ‰¹é‡å½•å…¥
function executeBatchEntry() {
    // è·å–é€‰ä¸­çš„å‘˜å·¥
    const checkboxes = document.querySelectorAll('#batch-employees input[type="checkbox"]:checked');
    const selectedEmployees = Array.from(checkboxes).map(cb => cb.value);

    if (selectedEmployees.length === 0) {
        alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå‘˜å·¥');
        return;
    }

    const startDate = document.getElementById('batch-start-date').value;
    const endDate = document.getElementById('batch-end-date').value;
    const hours = parseFloat(document.getElementById('batch-hours').value);
    const note = document.getElementById('batch-note').value;

    // éªŒè¯æ—¥æœŸ
    if (startDate > endDate) {
        alert('å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ');
        return;
    }

    // éªŒè¯å·¥æ—¶
    if (isNaN(hours) || hours < 0 || hours > 24) {
        alert('è¯·è¾“å…¥0-24ä¹‹é—´çš„å·¥æ—¶æ•°');
        return;
    }

    // è®¡ç®—æ—¥æœŸèŒƒå›´å†…çš„æ‰€æœ‰æ—¥æœŸ
    const dates = [];
    let current = new Date(startDate);
    const end = new Date(endDate);

    while (current <= end) {
        dates.push(formatDate(current));
        current.setDate(current.getDate() + 1);
    }

    // ç¡®è®¤
    const totalCount = selectedEmployees.length * dates.length;
    if (!confirm(`å°†ä¸º ${selectedEmployees.length} ä¸ªå‘˜å·¥åœ¨ ${dates.length} å¤©å†…å½•å…¥å·¥æ—¶\nå…± ${totalCount} æ¡è®°å½•ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ`)) {
        return;
    }

    // è·å–ç°æœ‰æ•°æ®
    worktimes = getData(DB_KEYS.WORKTIMES);

    // æ‰¹é‡æ·»åŠ 
    let addCount = 0;
    let updateCount = 0;

    selectedEmployees.forEach(empId => {
        dates.forEach(date => {
            const key = `${empId}_${date}`;
            const existing = worktimes.find(w => `${w.employee_id}_${w.date}` === key);

            if (existing) {
                // æ›´æ–°ç°æœ‰è®°å½•
                existing.work_hours = hours;
                existing.note = note;
                updateCount++;
            } else {
                // æ–°å¢è®°å½•
                worktimes.push({
                    id: generateId(),
                    employee_id: empId,
                    date: date,
                    work_hours: hours,
                    note: note
                });
                addCount++;
            }
        });
    });

    // ä¿å­˜æ•°æ®
    saveData(DB_KEYS.WORKTIMES, worktimes);

    // å…³é—­å¼¹çª—å¹¶åˆ·æ–°
    closeBatchModal();
    renderCalendar();

    // æ˜¾ç¤ºç»“æœ
    alert(`æ‰¹é‡å½•å…¥å®Œæˆï¼\næ–°å¢ï¼š${addCount} æ¡\næ›´æ–°ï¼š${updateCount} æ¡`);
}

// å®šæ—¶ä»»åŠ¡ç®¡ç†å™¨
const scheduleManager = {
    tasks: [],
    taskIdCounter: 0,

    add(task) {
        const id = ++this.taskIdCounter;
        task.id = id;
        this.tasks.push(task);
        this.renderTasks();
        this.startCountdown(task);
        return id;
    },

    remove(id) {
        const index = this.tasks.findIndex(t => t.id === id);
        if (index !== -1) {
            clearTimeout(this.tasks[index].timerId);
            clearInterval(this.tasks[index].intervalId);
            this.tasks.splice(index, 1);
            this.renderTasks();
        }
    },

    execute(task) {
        // è®¾ç½®è¡¨å•æ•°æ®å¹¶æ‰§è¡Œ
        document.getElementById('batch-start-date').value = task.startDate;
        document.getElementById('batch-end-date').value = task.endDate;
        document.getElementById('batch-hours').value = task.hours;
        document.getElementById('batch-note').value = task.note || '';

        // é‡æ–°é€‰ä¸­å‘˜å·¥
        const checkboxes = document.querySelectorAll('#batch-employees input[type="checkbox"]');
        checkboxes.forEach(cb => {
            cb.checked = task.employees.includes(cb.value);
        });

        // æ‰§è¡Œå½•å…¥
        executeBatchEntry();

        // æ’­æ”¾æç¤ºéŸ³
        this.playNotificationSound();

        // ç§»é™¤ä»»åŠ¡
        this.remove(task.id);
    },

    startCountdown(task) {
        // è®¾ç½®å®šæ—¶å™¨
        const delay = task.executeTime - new Date();
        task.timerId = setTimeout(() => {
            this.execute(task);
        }, delay);

        // æ›´æ–°å€’è®¡æ—¶æ˜¾ç¤º
        task.intervalId = setInterval(() => {
            this.renderTasks();
        }, 1000);
    },

    renderTasks() {
        const container = document.getElementById('active-schedules');
        if (this.tasks.length === 0) {
            container.innerHTML = '';
            return;
        }

        container.innerHTML = this.tasks.map(task => {
            const now = new Date();
            const diff = task.executeTime - now;

            if (diff <= 0) return '';

            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            return `
                <div class="schedule-item">
                    <div class="schedule-item-header">
                        <span class="schedule-item-time">â° ${task.executeTime.toLocaleString('zh-CN')}</span>
                        <button class="schedule-cancel" onclick="scheduleManager.remove(${task.id})">å–æ¶ˆ</button>
                    </div>
                    <div class="schedule-item-countdown">å€’è®¡æ—¶ï¼š${hours}æ—¶ ${minutes}åˆ† ${seconds}ç§’</div>
                    <div class="schedule-item-info">
                        ${task.employees.length} ä¸ªå‘˜å·¥ Ã— ${task.dayCount} å¤© Ã— ${task.hours} å°æ—¶
                    </div>
                </div>
            `;
        }).join('');
    },

    playNotificationSound() {
        // åˆ›å»ºéŸ³é¢‘æç¤º
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
    }
};

// åˆ‡æ¢å®šæ—¶é€‰é¡¹æ˜¾ç¤º
function toggleSchedule() {
    const enableSchedule = document.getElementById('enable-schedule').checked;
    const scheduleInputs = document.getElementById('schedule-inputs');
    const submitBtn = document.getElementById('batch-submit-btn');

    if (enableSchedule) {
        scheduleInputs.style.display = 'block';
        submitBtn.textContent = 'è®¾ç½®å®šæ—¶ä»»åŠ¡';
    } else {
        scheduleInputs.style.display = 'none';
        submitBtn.textContent = 'ç«‹å³å½•å…¥';
    }
}

// åˆ›å»ºå®šæ—¶ä»»åŠ¡
function createSchedule(executeTime) {
    const checkboxes = document.querySelectorAll('#batch-employees input[type="checkbox"]:checked');
    const selectedEmployees = Array.from(checkboxes).map(cb => cb.value);

    const startDate = document.getElementById('batch-start-date').value;
    const endDate = document.getElementById('batch-end-date').value;
    const hours = parseFloat(document.getElementById('batch-hours').value);
    const note = document.getElementById('batch-note').value;

    // éªŒè¯
    if (selectedEmployees.length === 0) {
        alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå‘˜å·¥');
        return;
    }

    if (startDate > endDate) {
        alert('å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ');
        return;
    }

    if (isNaN(hours) || hours < 0 || hours > 24) {
        alert('è¯·è¾“å…¥0-24ä¹‹é—´çš„å·¥æ—¶æ•°');
        return;
    }

    // è®¡ç®—å¤©æ•°
    const dayCount = Math.ceil((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24)) + 1;

    // åˆ›å»ºä»»åŠ¡
    scheduleManager.add({
        employees: selectedEmployees,
        startDate: startDate,
        endDate: endDate,
        dayCount: dayCount,
        hours: hours,
        note: note,
        executeTime: executeTime
    });

    // é‡ç½®è¡¨å•
    document.getElementById('batch-form').reset();
    document.getElementById('schedule-inputs').style.display = 'none';
    document.getElementById('batch-submit-btn').textContent = 'ç«‹å³å½•å…¥';

    // é‡æ–°åŠ è½½å‘˜å·¥åˆ—è¡¨
    const employees = getData(DB_KEYS.EMPLOYEES);
    const checkboxContainer = document.getElementById('batch-employees');
    checkboxContainer.innerHTML = `
        <div class="checkbox-actions">
            <button type="button" class="btn btn-sm btn-primary" onclick="toggleAllEmployees(true)">å…¨é€‰</button>
            <button type="button" class="btn btn-sm btn-secondary" onclick="toggleAllEmployees(false)">å…¨ä¸é€‰</button>
        </div>
        ${employees.map(emp => `
            <div class="checkbox-item">
                <input type="checkbox" id="batch-emp-${emp.id}" value="${emp.employee_id}" checked>
                <label for="batch-emp-${emp.id}">${emp.name} (${emp.employee_id})</label>
            </div>
        `).join('')}
    `;

    alert(`å®šæ—¶ä»»åŠ¡å·²è®¾ç½®ï¼\nå°†åœ¨ ${executeTime.toLocaleString('zh-CN')} è‡ªåŠ¨æ‰§è¡Œ\nè¯·ä¿æŒé¡µé¢æ‰“å¼€`);
}

// ==================== ç»Ÿè®¡æŠ¥è¡¨ ====================

function loadEmployeeOptions(selectId = 'stats-employee') {
    const data = getData(DB_KEYS.EMPLOYEES);
    const select = document.getElementById(selectId);
    const currentValue = select.value;

    const options = data.map(emp =>
        `<option value="${emp.employee_id}">${emp.name} (${emp.employee_id})</option>`
    ).join('');

    select.innerHTML = '<option value="">å…¨éƒ¨å‘˜å·¥</option>' + options;
    select.value = currentValue;

    // åˆå§‹åŒ–ç»Ÿè®¡æŠ¥è¡¨äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœå°šæœªåˆå§‹åŒ–ï¼‰
    initStatisticsEventListeners();
}

function initStatisticsEventListeners() {
    // ä¸ºæ‰€æœ‰ç­›é€‰å™¨æ·»åŠ changeäº‹ä»¶ç›‘å¬å™¨
    const employeeSelect = document.getElementById('stats-employee');
    const startDateInput = document.getElementById('stats-start');
    const endDateInput = document.getElementById('stats-end');
    const sortSelect = document.getElementById('stats-sort');

    // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§ç›‘å¬å™¨
    if (employeeSelect) {
        employeeSelect.removeEventListener('change', loadStatistics);
        employeeSelect.addEventListener('change', loadStatistics);
    }
    if (startDateInput) {
        startDateInput.removeEventListener('change', loadStatistics);
        startDateInput.addEventListener('change', loadStatistics);
    }
    if (endDateInput) {
        endDateInput.removeEventListener('change', loadStatistics);
        endDateInput.addEventListener('change', loadStatistics);
    }
    if (sortSelect) {
        sortSelect.removeEventListener('change', loadStatistics);
        sortSelect.addEventListener('change', loadStatistics);
    }
}

function loadStatistics() {
    const employeeId = document.getElementById('stats-employee').value;
    const startDate = document.getElementById('stats-start').value;
    const endDate = document.getElementById('stats-end').value;

    const allWorktimes = getData(DB_KEYS.WORKTIMES);
    const allEmployees = getData(DB_KEYS.EMPLOYEES);

    // åˆ›å»ºå‘˜å·¥æ˜ å°„
    const empMap = {};
    allEmployees.forEach(e => empMap[e.employee_id] = e.name);

    // ç­›é€‰æ•°æ®
    let filtered = allWorktimes;

    if (employeeId) {
        filtered = filtered.filter(w => w.employee_id === employeeId);
    }

    if (startDate) {
        filtered = filtered.filter(w => w.date >= startDate);
    }

    if (endDate) {
        filtered = filtered.filter(w => w.date <= endDate);
    }

    // æŒ‰å‘˜å·¥ç»Ÿè®¡
    const stats = {};
    filtered.forEach(wt => {
        if (!stats[wt.employee_id]) {
            stats[wt.employee_id] = {
                name: empMap[wt.employee_id] || wt.employee_id,
                total_hours: 0,
                record_count: 0
            };
        }
        stats[wt.employee_id].total_hours += wt.work_hours;
        stats[wt.employee_id].record_count++;
    });

    // å¦‚æœæ²¡æœ‰é€‰æ‹©ç‰¹å®šå‘˜å·¥ï¼Œæ˜¾ç¤ºæ‰€æœ‰å‘˜å·¥ï¼ˆåŒ…æ‹¬æ²¡æœ‰è®°å½•çš„ï¼‰
    if (!employeeId) {
        allEmployees.forEach(emp => {
            if (!stats[emp.employee_id]) {
                stats[emp.employee_id] = {
                    name: emp.name,
                    total_hours: 0,
                    record_count: 0
                };
            }
        });
    }

    let data = Object.values(stats);

    // è·å–æ’åºé€‰é¡¹
    const sortOption = document.getElementById('stats-sort').value;

    // æ ¹æ®æ’åºé€‰é¡¹æ’åº
    data.sort((a, b) => {
        switch (sortOption) {
            case 'name_asc':
                return a.name.localeCompare(b.name);
            case 'name_desc':
                return b.name.localeCompare(a.name);
            case 'hours_asc':
                return a.total_hours - b.total_hours;
            case 'hours_desc':
                return b.total_hours - a.total_hours;
            case 'count_asc':
                return a.record_count - b.record_count;
            case 'count_desc':
                return b.record_count - a.record_count;
            default:
                return 0;
        }
    });

    renderStatistics(data);
}

function renderStatistics(data) {
    const tbody = document.querySelector('#statistics-table tbody');

    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="empty-state">æš‚æ— æ•°æ®</td></tr>';
        return;
    }

    tbody.innerHTML = data.map(item => `
        <tr>
            <td>${item.name}</td>
            <td>${item.total_hours} å°æ—¶</td>
            <td>${item.record_count} æ¡</td>
        </tr>
    `).join('');
}

// ==================== æ•°æ®ç®¡ç† ====================

// å¯¼å‡ºæ•°æ®
function exportData() {
    const data = {
        version: '1.0',
        exportDate: new Date().toISOString(),
        employees: getData(DB_KEYS.EMPLOYEES),
        worktimes: getData(DB_KEYS.WORKTIMES)
    };

    const jsonStr = JSON.stringify(data, null, 2);
    const blob = new Blob([jsonStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = `å·¥æ—¶æ•°æ®_${formatDate(new Date())}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    alert('æ•°æ®å¯¼å‡ºæˆåŠŸï¼');
}

// å¯¼å…¥æ•°æ®
function importData(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);

            // éªŒè¯æ•°æ®æ ¼å¼
            if (!data.employees || !data.worktimes) {
                alert('æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼');
                return;
            }

            // ç¡®è®¤å¯¼å…¥
            const msg = `æ‰¾åˆ° ${data.employees.length} ä¸ªå‘˜å·¥ï¼Œ${data.worktimes.length} æ¡å·¥æ—¶è®°å½•\n\nç¡®å®šè¦å¯¼å…¥å—ï¼Ÿï¼ˆå°†è¦†ç›–ç°æœ‰æ•°æ®ï¼‰`;
            if (!confirm(msg)) return;

            // ä¿å­˜æ•°æ®
            saveData(DB_KEYS.EMPLOYEES, data.employees);
            saveData(DB_KEYS.WORKTIMES, data.worktimes);

            // åˆ·æ–°å½“å‰é¡µé¢
            loadEmployees();
            alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼');
        } catch (err) {
            alert('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯');
        }
    };
    reader.readAsText(file);

    // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
    event.target.value = '';
}

// æ¸…é™¤æ•°æ®
function clearData() {
    if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
    if (!confirm('å†æ¬¡ç¡®è®¤ï¼šçœŸçš„è¦åˆ é™¤æ‰€æœ‰å‘˜å·¥å’Œå·¥æ—¶è®°å½•å—ï¼Ÿ')) return;

    localStorage.removeItem(DB_KEYS.EMPLOYEES);
    localStorage.removeItem(DB_KEYS.WORKTIMES);

    employees = [];
    worktimes = [];
    loadEmployees();
    alert('æ•°æ®å·²æ¸…é™¤');
}

// ==================== åˆå§‹åŒ– ====================

// é»˜è®¤åŠ è½½å‘˜å·¥åˆ—è¡¨
loadEmployees();

// åˆå§‹åŒ–ç»Ÿè®¡æŠ¥è¡¨äº‹ä»¶ç›‘å¬å™¨
initStatisticsEventListeners();
    </script>
</body>
</html>
